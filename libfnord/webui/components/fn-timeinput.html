<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.

  todo: add seconds-selectable and render third input if attr is set
-->
<template id="fn-input-time-base-tpl">
  <style>
    #timeinput_container {
      margin:auto;
      width: 100%;
      min-height: 42px;
      display:block;
    }

    fn-input {
      position:relative;
      left: 15%;
      width: 30%;
      display: block;
      float:left;
    }


    b {
      float:left;
      position: relative;
      left: 15%;
      margin-left: 5px;
      margin-right: 5px;
      line-height: 42px;
    }
  </style>

  <div id="timeinput_container">
    <fn-input id="hours" data-style="small"></fn-input>
    <b>:</b>
    <fn-input id="minutes" data-style="small"></fn-input>
  </div>
</template>
<script type="text/javascript">
  var TimeInputComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-input-time", "base");
      var shadow = this.createShadowRoot();
      var base = this;
      shadow.appendChild(tpl);

      var hours_input = this.shadowRoot.querySelector("#hours");
      var minutes_input = this.shadowRoot.querySelector("#minutes");

      if (this.hasAttribute('data-hours-value')) {this.setHoursValue();}
      if (this.hasAttribute('data-minute-value')) {this.setMinutesValue();}

      this.attributeChangedCallback();

      hours_input.addEventListener('fn-input-submit', function(e) {
        base.validateHoursInput(e.detail);
      }, false);

      minutes_input.addEventListener('fn-input-submit', function(e) {
        base.validateMinutesInput(e.detail);
      }, false);
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case 'data-hours-value':
          this.setHoursValue();
          break;
        case 'data-minutes-value':
          this.setMinutesValue();
          break;
        default:
          break;
      }
    };

    this.appendLeadingZero = function(num) {
      if (typeof num == 'string') {
        return (num.length > 1)? num : "0" + num;
      }
      return (num > 9)? num : "0" + num;
    }

    this.validateHoursInput = function(value) {
      var input = this.shadowRoot.querySelector("#hours");
      if (value > 23) {
        input.setAttribute('data-state', 'error');
      } else {
        input.removeAttribute('data-state');
        this.setAttribute('data-hours-value', value);
        this.fireTimeInputSubmitEvent();
      }
    };

    this.validateMinutesInput = function(value) {
      var input = this.shadowRoot.querySelector("#minutes");
      if (value > 59) {
        input.setAttribute('data-state', 'error');
      } else {
        input.removeAttribute('data-state');
        this.setAttribute('data-minutes-value', value);
        this.fireTimeInputSubmitEvent();
      }
    };

    this.setHoursValue = function() {
      var value = this.appendLeadingZero(
        this.getAttribute('data-hours-value'));
      var input = this.shadowRoot.querySelector("#hours");
      input.setAttribute('data-value', value);
    };

    this.setMinutesValue = function() {
      var value = this.appendLeadingZero(
        this.getAttribute('data-minutes-value'));
      var input = this.shadowRoot.querySelector("#minutes");
      input.setAttribute('data-value', value);
    };

    this.fireTimeInputSubmitEvent = function() {
      this.dispatchEvent(new Event('fn-input-time-submit'));
    };
  }

  window.addEventListener('fn-ready', function() {
    var timeinput = Fnord.registerComponent('fn-input-time', TimeInputComponent);
  }, false);
</script>

