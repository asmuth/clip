<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style>
  fn-menu {
    display: block;
  }


</style>
<template id="fn-menu-base-tpl">
  <style type="text/css">
    ul, li {
      list-style-type: none;
      padding: 0;
      margin: 0;
      font-family: 'Helvetica Neue',Arial,Helvetica,sans-serif;
      color: rgba(0,0,0,.8);
      font-size: 14px;
    }

    ul.menu {
      margin: 1rem 0rem;
      background: #ffffff;
      font-weight: normal;
      box-shadow: 0px 0px 0px 1px rgba(39, 41, 43, 0.15), 0px 1px 2px 0 rgba(0, 0, 0, 0.05);
      border-radius: 0.2857rem;
    }

    ul.menu::after {
      content: '';
      display: block;
      height: 0px;
      clear: both;
      visibility: hidden;
    }

    ul.menu:first-child {
      margin-top: 0rem;
      border-top:none;
    }

    ul.menu:last-child {
      margin-bottom: 0rem;
    }

    ul.menu > li {
      background: none;
      display: block;
      height: auto!important;
      border-top: none;
      border-left: 0 solid transparent;
      border-right: none;
      position: relative;
      display: block;
      padding: 0.78571em 0.95em;
      border-top: none;
      background: none;
      vertical-align: middle;
      line-height: 1;
      text-decoration: none;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
         -moz-user-select: none;
          -ms-user-select: none;
              user-select: none;
      -webkit-transition: opacity 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
              transition: opacity 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
      font-size: 1rem;
      line-height: 1.3;
      font-weight: 500;
    }

    ul.menu > li:first-child::before {
      height: 0px;
    }

    ul.menu > li::before {
      position: absolute;
      content: '';
      top: 0%;
      left: 0px;
      width: 100%;
      background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0.03) 0%, rgba(0, 0, 0, 0.1) 1.5em, rgba(0, 0, 0, 0.03) 100%);
      background: linear-gradient(to right, rgba(0, 0, 0, 0.03) 0%, rgba(0, 0, 0, 0.1) 1.5em, rgba(0, 0, 0, 0.03) 100%);
      height: 1px;
    }

    ul.menu > li.item:hover {
      cursor: pointer;
      background: rgba(0, 0, 0, 0.03);
      color: rgba(0, 0, 0, 0.8);
    }



    /* submenu */
    ul.menu > li.submenu:first-child {
      border-radius: 0.2857rem 0.2857rem 0px 0px;
    }

    ul.menu > li.submenu:last-child {
      border-radius: 0px 0px 0.2857rem 0.2857rem;
    }

    ul.menu > li > .submenu_title {
      padding-bottom: 4px;
      line-height: 1.3;
      font-weight: 500;
      font-size: 1rem;
    }


    ul.menu > li > ul > li.item {
      background: 0 0;
      padding: .5rem 1rem;
      font-size: .935rem;
      color: rgba(0,0,0,.5);
    }

    ul.menu >li > ul > li.item[data-active] {
      color: rgba(0,0,0,.8);
      font-weight: 500;
    }

    ul.menu > li > ul > li.item:hover {
      color: rgba(0, 0, 0, 0.85);
      cursor: pointer;
    }

    li.submenu.accordion ul {
      display:none;
    }

    li.submenu.accordion[data-active] ul {
      display:block;
    }

    ul.menu li.submenu.accordion {
      padding: 0;
    }

    ul.menu li.submenu.accordion .submenu_title {
      padding: 0.78571em 0.95em;
    }

    ul.menu li.submenu.accordion .submenu_title:hover{
      cursor: pointer;
      background: rgba(0, 0, 0, 0.03);
      color: rgba(0, 0, 0, 0.8);
    }

    ul.menu li.submenu.accordion > ul > li.item {
      padding: .5rem 1rem .5rem 2rem;
    }

    ul.menu li.submenu.accordion > ul {
      padding-bottom: .95em;
    }

  </style>
  <ul class="menu"></ul>
  </span>
</template>

<script type="text/javascript">
  var MenuComponent = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate("fn-menu", "base");
      this.renderMenu(this, tpl.querySelector("ul.menu"));
      shadow.appendChild(tpl);
    };

    this.renderMenu = function(in_elem, out_elem) {
      for (var i = 0; i < in_elem.children.length; ++i) {
        var elem = in_elem.children[i];
        var base = this;

        if (elem.tagName == "FN-MENU-ITEM") {
          var onItemClick = (function(base, item) {
            return function(e) {
              base.clickItem(item, e.srcElement);
            };
          })(this, elem);

          var li_elem = document.createElement("li");
          li_elem.className = "item";
          li_elem.innerHTML = elem.innerHTML;
          li_elem.addEventListener("click", onItemClick, false);
          out_elem.appendChild(li_elem);

          li_elem.onclick = base.fireButtonClickEvent;
        }

        if (elem.tagName == "FN-SUBMENU") {
          var ul_elem = document.createElement("ul");
          this.renderMenu(elem, ul_elem);

          var li_elem = document.createElement("li");
          li_elem.className = "submenu";

          var type = this.getAttribute('data-type');
          if (type != null) {
            li_elem.className += " " +  type;
          }

          var submenu_title = elem.querySelector("fn-submenu-title");
          if (submenu_title) {
            var title_elem = document.createElement("div");
            title_elem.className = "submenu_title";
            title_elem.innerHTML = submenu_title.innerHTML;
            li_elem.appendChild(title_elem);

            if (type == 'accordion') {
              title_elem.onclick = function() {
                base.toggleAccordionSubmenu(this);
              }
            }
          }

          li_elem.appendChild(ul_elem);
          out_elem.appendChild(li_elem);

        }
      }
    }

    this.toggleAccordionSubmenu = function(elem) {
      var active_submenu = this.shadowRoot.querySelector("li[data-active]");

      if (!(elem.parentNode.hasAttribute('data-active'))) {
        console.log("set attribute");
        elem.parentNode.setAttribute('data-active', 'active');
      }

      if (active_submenu) {
        active_submenu.removeAttribute('data-active');
      }
    }

    this.clickItem = function(item, shadow) {
      var active_items = this.querySelectorAll("li.item[data-active]");
      for (var i = 0; i < active_items.length; ++i) {
        active_items[i].removeAttribute("data-active");
      }

      var active_shadow_items = this.shadowRoot.querySelectorAll(
          "li.item[data-active]");
      for (var i = 0; i < active_shadow_items.length; ++i) {
        active_shadow_items[i].removeAttribute("data-active");
      }

      shadow.setAttribute("data-active", true);
      item.setAttribute("data-active", true);

      var ev = new CustomEvent("fn-menu-item-click", {
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);
    }

  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-menu", MenuComponent);
  }, false);
</script>
