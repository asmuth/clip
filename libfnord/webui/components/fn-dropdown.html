<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style>
  fn-dropdown {
    display: block;
  }

  fn-dropdown[data-style="inline"] {
    display: inline-block;
  }

</style>

<template id="fn-dropdown-base-tpl">
  <style>
    /*******************************
            Basic
    *******************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    ::selection {
      background-color: rgba(255,255,160,.4);
      color: rgba(0,0,0,.8);
    }

    input {
      letter-spacing: normal;
      word-spacing: normal;
      text-transform: none;
      text-indent: 0px;
      text-shadow: none;
      display: inline-block;
      text-align: start;
    }


    #dropdown_ui {
      cursor: pointer;
      position: relative;
      display: inline-block;
      line-height: 1em;
      outline: 0;
      text-align:left;
      transition: border-radius .1s ease,width .2s ease;
      font-family: 'Helvetica Neue',Arial,Helvetica,sans-serif;
      font-size: 14px;
      color: rgba(0,0,0,.8);
      z-index: 100;
      cursor: pointer;
    }

    .header {
      white-space: nowrap;
    }

    .text {
      display: inline-block;
      -webkit-transition: color .2s ease;
      transition: color .2s ease;
    }

    i.icon {
      display: inline-block;
      line-height: 1;
      height: 1em;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      font-weight: 400;
      font-style: normal;
      text-align: center;
      width: auto;
      margin: 0 0 0 1em;
    }


    ol, ul#menu {
      display: none;
      list-style: none;
      cursor: auto;
      position: absolute;
      outline: 0;
      top: 100%;
      left: 0;
      margin: 0;
      padding: 0;
      background: #fff;
      min-width: 100%;
      white-space: nowrap;
      font-size: 1rem;
      text-shadow: none;
      text-align: left;
      box-shadow: 0 1px 4px 0 rgba(0,0,0,.15);
      border: 1px solid rgba(39,41,43,.15);
      border-radius: 0 0 .2857rem .2857rem;
      -webkit-transition: opacity .2s ease;
      transition: opacity .2s ease;
      z-index: 11;
      will-change: transform,opacity;
    }

    ol, ul#menu[data-active] {
      display: block;
    }

    ol, ul, li {
      margin: 0;
      padding: 0;
      border: 0;
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
    }

    ol, ul > li.item {
      position: relative;
      cursor: pointer;
      display: block;
      border: none;
      height: auto;
      border-top: none;
      line-height: 1.2em;
      color: rgba(0, 0, 0, 0.8);
      padding: 0.65rem 1.25rem !important;
      font-size: 1rem;
      text-transform: none;
      font-weight: normal;
      box-shadow: none;
      -webkit-touch-callout: none;
    }

    li.item.active {
      background: transparent;
      font-weight: bold;
      color: rgba(0, 0, 0, 0.8);
      box-shadow: none;
      z-index: 12;
    }

    li.item:hover,
    li.item[hover] {
      background: rgba(0, 0, 0, 0.05);
      color: rgba(0, 0, 0, 0.8);
      z-index: 12;
    }

    /*******************************
          Dropdown Styles
    *******************************/

    /*--------------
      Input like
    ---------------*/
    #dropdown_ui.input {
      padding: .8em 1.1em;
      cursor: pointer;
      word-wrap: break-word;
      white-space: normal;
      outline: 0;
      -webkit-transform: rotateZ(0deg);
      transform: rotateZ(0deg);
      min-width: 180px;
      background: #fff;
      display: inline-block;
      color: rgba(0,0,0,.8);
      box-shadow: none;
      border: 1px solid rgba(39,41,43,.15);
      border-radius: .2857rem;
      -webkit-transition: border-radius .1s ease,width .2s ease,box-shadow .2s ease,border .2s ease;
      transition: border-radius .1s ease,width .2s ease,box-shadow .2s ease,border .2s ease;
    }

    #dropdown_ui.input .text {
      margin-right: 2em;
    }

    #dropdown_ui.input i.icon {
      position: absolute;
      top: auto;
      margin: 0em;
      width: auto;
      right: 1.1em;
      opacity: 0.8;
      -webkit-transition: opacity 0.2s ease;
      transition: opacity 0.2s ease;
    }

    #dropdown_ui.input ul#menu {
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-backface-visibility: hidden;
              backface-visibility: hidden;
      -webkit-overflow-scrolling: touch;
      border-top: none !important;
      width: auto;
      margin: 0px -1px;
      min-width: -webkit-calc(100% + 2px);
      min-width: calc(100% + 2px);
      outline: none;
      box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.08);
      -webkit-transition: box-shadow 0.2s ease, border 0.2s ease;
      transition: box-shadow 0.2s ease, border 0.2s ease;
    }

    #dropdown_ui.input.labeled ul#menu {
      border-top: 1px solid rgba(39,41,43,.15)!important;
    }

    @media only screen and (max-width: 767px) {
      #dropdown_ui.input ul#menu {
        max-height: 7.7142rem;
      }
    }
    @media only screen and (min-width: 768px) {
      #dropdown_ui.input ul#menu {
        max-height: 10.2856rem;
      }
    }
    @media only screen and (min-width: 992px) {
      #dropdown_ui.input ul#menu {
        max-height: 15.4284rem;
      }
    }
    @media only screen and (min-width: 1920px) {
      #dropdown_ui.input ul#menu {
        max-height: 20.5712rem;
      }
    }

    #dropdown_ui.input li.item {
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      padding-left: 1.1em !important;

    /* Add in spacing for scroll bar */
      padding-right: -webkit-calc(2.1em) !important;
      padding-right: calc(2.1em) !important;
      white-space: normal;
      word-wrap: normal;
    }

    #dropdown_ui.input li.item:hover,
    #dropdown_ui.input li.item[hover] {
      box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.05);
    }

    #dropdown_ui.input:hover {
      border-color: rgba(39, 41, 43, 0.3);
      box-shadow: 0px 0px 4px 0px rgba(0, 0, 0, 0.08);
    }

    #dropdown_ui.input:hover .menu {
      border: 1px solid rgba(39, 41, 43, 0.3);
      box-shadow: 0px 4px 6px 0px rgba(0, 0, 0, 0.08);
    }

     /*--------------
      Small Input like
    ---------------*/
    #dropdown_ui.input.small {
      min-width: 130px;
      font-size: 0.9rem;
    }
    #dropdown_ui.input.small ul#menu {
      min-width: 130px;
    }

    #dropdown_ui.input.small ul#menu li.item {
      font-size: 0.9rem;
    }


    /*--------------
      Compact Input like
    ---------------*/
    #dropdown_ui.input.compact ul#menu {
      min-width: 0px;
      width: auto;
    }

    #dropdown_ui.input.compact {
      min-width: 0px;
      width: auto;
    }


    /*--------------
      Inline
    ---------------*/
    #dropdown_ui.inline {
      cursor: pointer;
      display: inline-block;
      color: inherit;
    }

     #dropdown_ui.inline i.icon {
      margin: 0em 0.5em 0em 0.25em;
      vertical-align: top;
    }

    #dropdown_ui.inline .text {
      font-weight: bold;
    }

    #dropdown_ui.inline ul#menu{
      cursor: auto;
      margin-top: 0.25em;
      border-radius: 0.2857rem;
    }

    /*--------------
      Labeled
    ---------------*/
    #dropdown_ui li.label {
      margin: 1rem 0rem 0.75rem;
      padding: 0em 1.25rem;
      color: rgba(0, 0, 0, 0.85);
      font-size: 0.8em;
      font-weight: bold;
      text-transform: uppercase;
    }

    /*--------------
      Searchable
    ---------------*/
    #dropdown_ui.search {
      display: block;
      width: 100%;
      height: 38px;
      min-width: 0;
      font-size: 1em;
      position:relative;
    }

    #dropdown_ui.search input {
      background: none transparent;
      border: none;
      cursor: pointer;
      position: absolute;
      border-radius: 0em !important;
      top: 0em;
      left: 0em;
      width: 100%;
      outline: none;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
      padding: inherit;
      cursor: auto;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1em;
      color: #545758
    }

    #dropdown_ui.search i.icon {
      display: none;
    }

     #dropdown_ui.search ul#menu {
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-backface-visibility: hidden;
              backface-visibility: hidden;
      -webkit-overflow-scrolling: touch;
    }

    @media only screen and (max-width: 767px) {
      #dropdown_ui.search ul#menu{
        max-height: 7.7142rem;
      }
    }
    @media only screen and (min-width: 768px) {
      #dropdown_ui.search ul#menu{
        max-height: 10.2856rem;
      }
    }
    @media only screen and (min-width: 992px) {
      #dropdown_ui.search ul#menu {
        max-height: 15.4284rem;
      }
    }
    @media only screen and (min-width: 1920px) {
      #dropdown_ui.search ul#menu {
        max-height: 20.5712rem;
      }
    }

    /*--------------
      Error
    ---------------*/
    #dropdown_ui[data-state='error'],
    #dropdown_ui[data-state='error'] > .text {
      color: #a94442;
    }

    #dropdown_ui.input[data-state='error'] {
      background: #fff0f0;
      border-color: #dbb1b1;
    }

    #dropdown_ui.input[data-state='error']:hover {
      border-color: #dbb1b1;
    }

    #dropdown_ui[data-state='error'] ul#menu {
      border-color: #dbb1b1;
    }

    #dropdown_ui[data-state='error'] ul#menu li.item {
      color: #d95c5c;
    }

    #dropdown_ui[data-state='error'] ul#menu li.item:hover,
    #dropdown_ui[data-state='error'] ul#menu li.item[hover] {
      background-color: #fff2f2;
    }

    #dropdown_ui[data-state='error'] ul#menu li.item.active {
      background-color: #fdcfcf;
    }

    /*--------------
      Disabled
    ---------------*/
    #dropdown_ui[data-state='disabled'] {
      cursor: auto;
    }



  </style>

  <div id="dropdown_ui">
    <div class="header">
      <div class='text'>
        <content select='fn-dropdown-header'></content>
      </div>
      <i class="icon fa fa-caret-down"></i>
    </div>
    <ul id="menu">
    </ul>
  </div>
</template>

<script type="text/javascript">
  var DropDownComponent = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate("fn-dropdown", "base");
      shadow.appendChild(tpl);
      var base = this;

      /* options */
      if (this.hasAttribute('data-style')) {this.setStyle();}
      if (this.hasAttribute('data-state')) {this.setState();}
      if (this.hasAttribute('data-preselected')) {this.setPreselection();}

      if (this.hasAttribute('data-searchable')) {this.renderSearchInput();}

      this.attributeChangedCallback();

      this.addEventListener('click', function(e) {
        e.stopPropagation();
        base.toggleDisplayDropdown();
      }, false);

      document.addEventListener('click', function() {
        base.hideDropdown();
      }, false);

    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case "data-active":
          this.renderDropdown();
          break;
        case "data-style":
          this.setStyle();
          break;
        case "data-state":
          this.setState(new_val);
          break;
        case "data-preselected":
          this.setPreselection();
          break;
        default:
          break;
      }
    };

    /* styles currently can't be removed by changing the attribute */
    this.setStyle = function() {
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      var class_name = this.getAttribute('data-style');

      if (this.querySelector("fn-dropdown-label") != null) {
        class_name += " labeled";
      }

      dropdown_ui.className = class_name;
    };

    /* states can be added and removed */
    this.setState = function() {
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      dropdown_ui.setAttribute("data-state", this.getAttribute('data-state'));
    };

    /* preselection only works if data-value is set */
    this.setPreselection = function() {
      var value = this.getAttribute('data-preselected');
      var item = this.querySelector(
        "fn-dropdown-item[data-value='" + value + "']");

      if (item != null) {
        var text = item.innerHTML;
        this.updateHeader(text);
        item.setAttribute('data-active', true);
      }
    }

    this.renderSearchInput = function() {
      this.search_item = "";
      var input = document.createElement("input");
      var placeholder = this.getAttribute('data-placeholder');
      if (placeholder != null) {
        input.placeholder = placeholder;
      }
      var dropdown_ui = this.shadowRoot.querySelector("#dropdown_ui");
      dropdown_ui.className = "input search";
      var header = this.shadowRoot.querySelector(".header");
      dropdown_ui.insertBefore(input, header);

      var base = this;

      input.addEventListener('click', function() {
        base.search_item = "";
      }, false);

      input.addEventListener('keyup', function(e) {
        switch (e.keyCode) {
          case 38:
            base.keyNavigationUp();
            break;
          case 40:
            base.keyNavigationDown();
            break;
          case 13:
            base.keyNavigationSubmit();
            break;
          default:
            base.search_item = this.value.toLowerCase();
            base.renderDropdown();
            break;
        }
      }, false);
    };

    this.toggleDisplayDropdown = function() {
      var ul = this.shadowRoot.querySelector("ul");
      if (ul.hasAttribute("data-active")) {
        this.hideDropdown();
      } else {
        if (this.getAttribute('data-state') != "disabled") {
          this.renderDropdown();
        }
      }
    };

    this.hideDropdown = function() {
      var list = this.shadowRoot.querySelector("ul");
      list.removeAttribute("data-active");
      this.removeAttribute("data-active");
    };

    this.renderListLabel = function(label, list_elem) {
      var list_item = document.createElement("li");
      list_item.className = "label";
      list_item.innerHTML = label;
      list_elem.appendChild(list_item);
    };

    this.renderDropdown = function() {
      var ul = this.shadowRoot.querySelector("ul");
      ul.innerHTML = "";
      ul.setAttribute("data-active", "active");

      var items = this.querySelectorAll("fn-dropdown-item");
      var base = this;

      var label = this.querySelector("fn-dropdown-label");
      if (label != null) {this.renderListLabel(label.innerHTML, ul)};

      var index = 0;
      for (var i = 0; i < items.length; i++) {
        var elem = items[i];

        var onItemClick = (function(base, item) {
          return function(e) {
            e.stopPropagation();
            base.clickItem(item, e.srcElement);
          };
        })(this, elem);

        if (this.search_item && this.search_item.length > 0 ) {
          var value = elem.getAttribute("data-value").toLowerCase();
          if (value.indexOf(this.search_item) <= -1) {continue;}
        }


        var list_item = document.createElement("li");
        var class_name =
          elem.hasAttribute('data-active') ? "item active" : "item";
        list_item.className = class_name;
        list_item.innerHTML = elem.innerHTML;

        if (this.search_item != null) {
          list_item.setAttribute('data-index', index);
          index++;
        }
        ul.appendChild(list_item);
        list_item.addEventListener('click', onItemClick, false);
      }
    };

    this.clickItem = function(item, shadow) {
      var active_items = this.querySelectorAll("fn-dropdown-item[data-active]");
      for (var i = 0; i < active_items.length; ++i) {
        active_items[i].removeAttribute("data-active");
      }

      var active_shadow_items = this.shadowRoot.querySelectorAll(
          "li.item[data-active]");
      for (var i = 0; i < active_shadow_items.length; ++i) {
        active_shadow_items[i].removeAttribute("data-active");
      }

      shadow.setAttribute("data-active", true);
      item.setAttribute("data-active", true);

      var ev = new CustomEvent("fn-dropdown-item-click", {
        bubbles: true,
        cancelable: true
      });
      item.dispatchEvent(ev);

      this.updateHeader(shadow.innerText);
      this.hideDropdown();
    };

    this.updateHeader = function(text) {
      var header = this.querySelector("fn-dropdown-header");
      if (header != null && header.getAttribute('data-display-selection') == 'false') {return;}

      if (this.hasAttribute('data-searchable')) {
        this.shadowRoot.querySelector("input").value = text;
      } else {
        var shadow_header = this.shadowRoot.querySelector(".header .text");
        shadow_header.innerHTML = text;
      }
    };

    /* Searchable Dropdown Key Navigation */
    this.keyNavigationUp = function() {
      var hover_elem = this.shadowRoot.querySelector("li[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) - 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      }
    };

    this.keyNavigationDown = function() {
      var hover_elem = this.shadowRoot.querySelector("li[hover]");
      if (hover_elem != null) {
        var index = parseInt(hover_elem.getAttribute('data-index'), 10) + 1;
        var elem = this.shadowRoot.querySelector("li[data-index='" + index + "']");
        if (elem != null) {
          hover_elem.removeAttribute("hover");
          elem.setAttribute("hover", "hover");
          this.shadowRoot.querySelector("ul").scrollTop = elem.offsetTop;
        }
      } else {
        var elem = this.shadowRoot.querySelector("li[data-index='0']");
        elem.setAttribute("hover", "hover");
      }
    };

    this.keyNavigationSubmit = function() {
      var shadow_elem = this.shadowRoot.querySelector("li[hover]");
      if (shadow_elem != null) {
        var value = shadow_elem.innerText;
        var item = this.querySelector(
          "fn-dropdown-item[data-value='" + value + "']");
        this.clickItem(item, shadow_elem);
      }
    }

  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent("fn-dropdown", DropDownComponent);
  }, false);
</script>
