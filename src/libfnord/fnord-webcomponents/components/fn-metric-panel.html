<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->

<template id="fn-metric-panel-base-tpl">
  <fn-metric-panel-section data-content='metrics'>
    <fn-metric-panel-title>
      Metrics
    </fn-metric-panel-title>
    <fn-button data-action='add-metric'>
      <i class='fa fa-plus'></i> Metric
    </fn-button>
    <fn-metric-panel-clearfix></fn-metric-panel-clearfix>

    <fn-metrics>
    </fn-metrics>
  </fn-metric-panel-section>

  <fn-metric-panel-section data-content='dimensions'>
    <fn-metric-panel-title>
      Dimensions
    </fn-metric-panel-title>
    <fn-button data-action='add-dimension'>
      <i class='fa fa-plus'></i> Dimension
    </fn-button>
    <fn-metric-panel-clearfix></fn-metric-panel-clearfix>

    <fn-metric-dimensions>
    </fn-metric-dimensions>
  </fn-metric-panel-section>

  <fn-metric-panel-section data-content='filters'>
    <fn-metric-panel-title>
      Filters
    </fn-metric-panel-title>
    <fn-button data-action='add-filter'>
      <i class='fa fa-plus'></i> Filter
    </fn-button>
    <fn-metric-panel-clearfix></fn-metric-panel-clearfix>

    <fn-metric-filters>
    </fn-metric-filters>
  </fn-metric-panel-section>

  <fn-metric-panel-section data-content='datetime'>
    <fn-metric-panel-title>
      Time Range
    </fn-metric-panel-title>
    <fn-metric-panel-clearfix></fn-metric-panel-clearfix>

    <fn-date-select>
    </fn-date-select>
  </fn-metric-panel-section>
</template>
<script type='text/javascript'>
  var MetricPanel = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate('fn-metric-panel', 'base');
      this.appendChild(tpl);
      this.render();
      this.observeLinks();

    };

    this.render = function() {
      if (this.hasAttribute('data-from') && this.hasAttribute('data-until')) {
        this.renderDateTimeContent();
      }

      if (this.hasAttribute('data-metrics')) {
        this.renderMetricContent();
      }

      if (this.hasAttribute('data-dimensions')) {
        this.renderDimensionContent();
      }


      if (this.hasAttribute('data-filters')) {
        this.renderFilterContent();
      }
    };

    this.observeLinks = function() {
      var _this = this;
      var links = this.querySelectorAll("fn-button");
      for (var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', function() {
          var ev = new Event('fn-metric-panel-' + this.getAttribute('data-action'));
          _this.dispatchEvent(ev);
        }, false);
      }
    }

    this.createRemovableItem = function(content_item, onRemove) {
      var item = document.createElement("fn-metric-panel-item");
      var icon = document.createElement("i");
      var title = document.createElement("div");

      icon.className = "fa fa-times";
      title.innerHTML = content_item.name;

      item.appendChild(title);
      item.appendChild(icon);
      item.setAttribute('data-key', content_item.key);

      icon.addEventListener('click', function() {
        onRemove(content_item);
      });

      return item;
    };


    this.removeContentItem = function(key, removed_item) {
      var items = JSON.parse(this.getAttribute('data-' + key + 's'));
      var ev = new CustomEvent('fn-metric-panel-remove-' + key, {
        detail: {key: removed_item},
        cancelable: true,
        bubbles: true
      });

      for (var i = 0; i < items.length; i++) {
        if (items[i].key == removed_item.key) {
          items.splice(i, 1);
          break;
        }
      }

      this.setAttribute('data-' + key + 's', items);
      this.dispatchEvent(ev);
    }


    this.renderMetricContent = function() {
      var _this = this;
      var section = this.querySelector(
        "fn-metric-panel-section[data-content='metrics']");
      var metrics_elem = section.querySelector("fn-metrics");
      var metrics = JSON.parse(this.getAttribute('data-metrics'));
      metrics_elem.innerHTML = "";

      metrics.forEach(function(metric) {
        metrics_elem.appendChild(
           _this.createRemovableItem(metric, _this.removeContentItem.bind(_this, 'metric')));
      });

      section.setAttribute('data-resolved', 'resolved');
    };


    this.renderDimensionContent = function() {
      var _this = this;
      var section = this.querySelector(
        "fn-metric-panel-section[data-content='dimensions']");
      var dimensions_elem = section.querySelector("fn-metric-dimensions");
      var dimensions = JSON.parse(this.getAttribute('data-dimensions'));
      dimensions_elem.innerHTML = "";

      dimensions.forEach(function(dimension) {
        dimensions_elem.appendChild(
          _this.createRemovableItem(
            dimension, _this.removeContentItem.bind(_this, 'dimension')));
      });

      section.setAttribute('data-resolved', 'resolved');
    };


    this.renderFilterContent = function() {
      var _this = this;
      var section = this.querySelector(
        "fn-metric-panel-section[data-content='filters']");
      var filters_elem = section.querySelector("fn-metric-filters");
      var filters = JSON.parse(this.getAttribute('data-filters'));
      filters_elem.innerHTML = "";

      filters.forEach(function(filter) {
        filters_elem.appendChild(
          _this.createRemovableItem(
            filter, _this.removeContentItem.bind(_this, 'filter')));
      });

      section.setAttribute('data-resolved', 'resolved');
    };

    this.renderDateTimeContent = function() {
      var section = this.querySelector(
        "fn-metric-panel-section[data-content='datetime']");
      var dateselect = section.querySelector("fn-date-select");
      dateselect.setAttribute('data-from', this.getAttribute('data-from'));
      dateselect.setAttribute('data-until', this.getAttribute('data-until'));
      dateselect.setAttribute('data-resolved', 'resolved');

      section.setAttribute('data-resolved', 'resolved');
    };


  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-panel', MetricPanel);
  });
</script>
