<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id='fn-date-select-base-tpl'>
  <fn-date-select-field>
  </fn-date-select-field>

  <fn-date-select-widget>
    <fn-date-select-inner>

      <fn-calendar-group data-selectable='past' data-select='from'></fn-calendar-group>

      <fn-date-select-controls>

        <fn-date-select-input-header>Date Range</fn-date-select-input-header>
        <fn-dropdown class='input' >
          <fn-dropdown-items>
          </fn-dropdown-items>
        </fn-dropdown>

        <div style='clear: both'></div>

        <fn-date-select-container>
          <input class='fn-input date-select-highlight' readonly data-action='date-select-from' />
          <fn-date-select-separator>&#45;</fn-date-select-separator>
          <input class='fn-input' readonly data-action='date-select-until' />
        </fn-date-select-container>

        <fn-button data-action='date-select-cancel'>Cancel</fn-button>
        <fn-button data-action='date-select-apply'>Apply</fn-button>

      </fn-date-select-controls>

    </fn-date-select-inner>
  </fn-date-select-widget>

</template>

<script type-'text/javascript'>
  var DateSelect = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate('fn-date-select', 'base');
      this.appendChild(tpl);

      //you may want to customize this
      this.selectableRanges = {
        'custom' : 'Custom',
        0 : 'Today',
        86400000 : 'Yesterday',
        604800000 : 'Last 7 Days',
        2592000000 : 'Last 30 Days'
      }

      if (this.hasAttribute('data-resolved')) {
        this.init();
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-resolved') {
        this.init();
      }
    };

    this.init = function() {
      var _this = this;

      this.querySelector("fn-date-select-field").onclick = function(e) {
        e.stopPropagation();
        _this.toggleWidgetVisibility();
      };

      this.querySelector("fn-date-select-widget").onclick = function(e) {
        e.stopPropagation();
      };

      var from = DateUtil.getStartOfDay(
        DateUtil.parseTimestamp(this.getAttribute('data-from')));
      var until = DateUtil.getStartOfDay(
        DateUtil.parseTimestamp(this.getAttribute('data-until')));

      this.applied = {
        'from' : from,
        'until' : until
      };

      this.initWidget();
      this.renderPreviewField();

      this.observeRangeDropdown();
      this.observeCalendar();
      this.observeRangeFields();
      this.observeButtons();
    };

    this.initWidget = function() {
      var from = this.applied.from;
      var until = this.applied.until;

      this.editing = {
        'from' : from,
        'until' : until,
        'select' : 'from'
      };

      this.renderCalendar(from, until);
      this.renderRangeDropdown();
      this.setRangeFields(from, until);
      this.setSelectedRange(from, until);
    };


    this.renderPreviewField = function() {
      this.querySelector("fn-date-select-field").innerHTML =
        this.getDateDescription(this.applied.from) + " - " +
        this.getDateDescription(this.applied.until);
    };


    this.setSelectedRange = function(from, until) {
      var range = new Date().getTime() - from ;
      var range_val = (range in this.selectableRanges) ?
        range : 'custom';

      var active_item = this.querySelector("fn-dropdown-item[data-selected]");

      if (active_item) {
        active_item.removeAttribute('data-selected');
      }

      this.querySelector("fn-dropdown-item[data-value='" + range_val + "']")
        .setAttribute('data-selected', 'selected');

      this.querySelector("fn-dropdown").setHeaderValue();
    };

    /**
      * Set State and Content
      */
    this.setRangeFields = function(from, until) {
      var from_field = this.querySelector("input[data-action='date-select-from']");
      var until_field = this.querySelector("input[data-action='date-select-until']");
      var range = this.selectableRanges[until - from];

      from_field.value = this.getDateDescription(from);
      until_field.value = this.getDateDescription(until);

      if (range) {
        from_field.classList.remove('date-select-active');
        until_field.classList.remove('date-select-active');
      } else {
        //custom
        this.brightenRangeFields();
      }
    };


    this.brightenRangeFields = function() {
      var inputs = this.querySelectorAll("input");

      for (var i = 0; i < inputs.length; i++) {
        inputs[i].classList.add('date-select-active');
      }
    };


    this.highlightRangeField = function() {
      this.querySelector("input.date-select-highlight")
        .classList.remove('date-select-highlight');

      this.querySelector(
        "input[data-action='date-select-" + this.editing.select + "']")
        .classList.add("date-select-highlight");
    };



    this.renderRangeDropdown = function() {
      var items = this.querySelector("fn-dropdown-items");

      for (var key in this.selectableRanges) {
        var item = document.createElement("fn-dropdown-item");
        item.setAttribute('data-value', key);
        item.innerHTML = this.selectableRanges[key];

        items.appendChild(item);
      }

      this.querySelector("fn-dropdown")
        .setAttribute('data-resolved', 'resolved');
    };



    this.renderCalendar = function(from, until, calendar_start) {
      var calendar = this.querySelector("fn-calendar-group");
      var start = (typeof calendar_start !== 'undefined') ?
        calendar_start : this.getCalendarStart(from, until);

      calendar.setAttribute('data-from', from);
      calendar.setAttribute('data-until', until);
      calendar.setAttribute('data-timestamp', start);
      calendar.setAttribute('data-select', this.editing.select);
      calendar.render();
    };

    this.getCalendarStart = function(from, until) {
      var start = DateUtil.getStartOfMonth(new Date().getTime(), -2);

      if (start < from) {
        return start;
      }

      return DateUtil.getStartOfMonth(until, -2);
    }


    this.toggleWidgetVisibility = function() {
      if (this.hasAttribute('data-active')) {
        this.removeAttribute('data-active');
      } else {
        this.setAttribute('data-active', 'active');
      }
    };

    this.getDateDescription = function(timestamp) {
      var date = new Date(timestamp);
      return (
        date.getFullYear() + "-" +
        Fnord.appendLeadingZero(date.getMonth() + 1) + "-" +
        Fnord.appendLeadingZero(date.getDate())
      );
    };


    /***************** Observe Controls ***********************/

    this.onRangeDropdownSelect = function(range) {
      if (range == 'custom') {
        return this.brightenRangeFields();
      }

      this.editing.until = DateUtil.getStartOfDay(new Date().getTime());
      this.editing.from = this.editing.until - range;

      //yesterday
      if (range == 86400000) {
        this.editing.until = this.editing.from;
      }

      this.setRangeFields(this.editing.from, this.editing.until);
      this.renderCalendar(this.editing.from, this.editing.until);
    };


    this.observeRangeDropdown = function() {
      var _this = this;

      this.querySelector("fn-dropdown")
        .addEventListener('fn-dropdown-item-click', function(e) {
          var target = e.target || e.srcElement;

          _this.onRangeDropdownSelect(target.getAttribute('data-value'));
          //_this.setSelect('from');*/
        },
      false);
    };

    this.onCalendarSelect = function(timestamp) {
      var timestamp = DateUtil.getStartOfDay(timestamp);

      if (this.editing.select === 'from') {
        this.editing.select = 'until';
        this.editing.from = timestamp;
      } else {
        this.editing.select = 'from';
        this.editing.until = timestamp;
      }

      this.highlightRangeField();
      this.brightenRangeFields();
      this.renderCalendar(this.editing.from, this.editing.until);
      this.setSelectedRange(this.editing.from, this.editing.until);
    };


    this.observeCalendar = function() {
      var _this = this;
      this.querySelector("fn-calendar-group")
        .addEventListener('fn-calendar-group-select', function(e) {
          _this.onCalendarSelect(e.detail.timestamp);
        },
      false);
    };

    this.onRangeFieldClick = function(select) {
      this.editing.select = select;
      this.brightenRangeFields();
      this.highlightRangeField();
      this.setSelectedRange();

      this.renderCalendar(
        this.editing.from, this.editing.until,
        this.querySelector("fn-calendar-group").firstDate.timestamp);
    };

    this.observeRangeFields = function() {
      var _this = this;

      this.querySelector("input[data-action='date-select-from']").onclick = function() {
        _this.onRangeFieldClick("from");
      }

      this.querySelector("input[data-action='date-select-until']").onclick = function() {
        _this.onRangeFieldClick("until");
      }
    };

    this.observeButtons = function() {
      var _this = this;

      this.querySelector("fn-button[data-action='date-select-cancel']")
        .onclick = function() {
          _this.toggleWidgetVisibility();
          _this.initWidget();
      }

      this.querySelector("fn-button[data-action='date-select-apply']")
        .onclick = function() {
          _this.applied.from = _this.editing.from;
          _this.applied.until = _this.editing.until;
          _this.toggleWidgetVisibility();
          _this.fireSelectEvent();
          _this.renderPreviewField();
      }

    }

    this.fireSelectEvent = function() {
      var ev = new CustomEvent('fn-date-select-apply', {
        'detail' : {'from' : this.applied.from, 'until' : this.applied.until},
        'bubbles' : true,
        'cancelable' : true
      });

      this.dispatchEvent(ev);
    }

    this.onDocumentClick = function() {
      this.removeAttribute('data-active');
    };

  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-date-select', DateSelect);
  });
</script>
