<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style type='text/css'>
  fn-calendar-group {
    display: block;
  }
</style>

<template id="fn-calendar-group-base-tpl">
  <style type='text/css'>
    table {
      font-size: 1em;
      line-height: 1em;
      color: rgba(0, 0, 0, 0.8);
      border-collapse: collapse;
      border-spacing: 0;
    }

    td {
      line-height: 1.3em;
      text-align:center;
      cursor: default;
      color: inherit;
      padding: 0;
      vertical-align: top;
    }

    /*table tr {
      height: 1.98em;
    }*/

    table th {
      padding: 0.4em;
      line-height: 1.3em;
      text-align: center;
      font-weight: normal;
      color: inherit;
    }

    td.border {
      border-left: 1px solid rgba(0, 0, 0, 0.1);
    }

    td.border.bottom {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    table.calendar td {
      padding: 0.45em 0.5em;
    }

    td.selectable:hover {
      cursor: pointer;
      background-color: #fffbe6;
    }

    tr.month_header td {
      text-align: center;
      background-color: rgba(0, 0, 0, 0.1);
    }

    tr.month_picker td {
      padding: 0;
    }

    .fa {
      color: inherit;
      padding-left: 0.4em;
      padding-right: 0.4em;
    }

    .fa:hover {
      cursor:pointer;
    }

    .month_picker {
      vertical-align: top;
    }

    .month_picker .picker {
      padding: 0.5em;
      color: rgba(0, 0, 0, 0.8);
      font-size: 0.8em;
      background-color: rgba(0, 0, 0, 0.1);
    }

    /**********************
      States
    ***********************/
    table tr.week td {
     color: rgba(0, 0, 0, 0.6); 
    }

    table tr.week td.selectable {
      color: rgba(0, 0, 0, 0.85);
    }

    table td.highlight {
      background-color: #f0f0f0;
    }

    table td.highlight_border {
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    table td.bright {
      opacity: 0.6;
    }

    table td.colored {
      background-color: #f0f0f0;
    }
  </style>

  <table id="group">
    <tr>
      <td id='prev_month_picker' class='month_picker'>
        <div class='picker'><i class='fa fa-chevron-left'></i></div>
      </td>

      <td class='border bottom'>
        <table class='calendar' id='0' cellspacing='0' cellpadding='0'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='0_week0'></tr>
          <tr class="week" id='0_week1'></tr>
          <tr class="week" id='0_week2'></tr>
          <tr class="week" id='0_week3'></tr>
          <tr class="week" id='0_week4'></tr>
          <tr class="week" id='0_week5'></tr>
        </table>
      </td>

      <td class='border bottom'>
        <table class='calendar' id='1' cellspacing='0' cellpadding='0'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='1_week0'></tr>
          <tr class="week" id='1_week1'></tr>
          <tr class="week" id='1_week2'></tr>
          <tr class="week" id='1_week3'></tr>
          <tr class="week" id='1_week4'></tr>
          <tr class="week" id='1_week5'></tr>
        </table>
      </td>

      <td class='border bottom'>
        <table class='calendar' id='2' cellspacing='0' cellpadding='0'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='2_week0'></tr>
          <tr class="week" id='2_week1'></tr>
          <tr class="week" id='2_week2'></tr>
          <tr class="week" id='2_week3'></tr>
          <tr class="week" id='2_week4'></tr>
          <tr class="week" id='2_week5'></tr>
        </table>
      </td>

      <td id='next_month_picker' class='month_picker border'>
        <div class='picker'><i class='fa fa-chevron-right'></i></div>
      </td>

    </tr>
  </table>
</template>
<script type='text/javascript'>
  var CalendarGroup = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate("fn-calendar-group", "base");
      shadow.appendChild(tpl);
      this.init();
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case 'data-from':
          return this.render(DateUtil.parseTimestamp(new_val));
        case 'data-until':
          return this.render(DateUtil.parseTimestamp(this.getAttribute('data-from')));
        default:
          break;
      }
    };

    this.init = function() {
      this.render(
        DateUtil.parseTimestamp(this.getAttribute('data-from'))
      );

      this.observeMonthSelectors();
    };

    this.observeMonthSelectors = function() {
      var _this = this;
      this.shadowRoot.getElementById('prev_month_picker').addEventListener('click',
        function() {
          _this.render(
            DateUtil.getMonthTimestamp(_this.firstDate.month, _this.firstDate.year, -1));
        },
      false);

      this.shadowRoot.getElementById('next_month_picker').addEventListener('click',
        function() {
          _this.render(
            DateUtil.getMonthTimestamp(_this.lastDate.month, _this.lastDate.year, -1));
        },
      false);

    }

    this.render = function(date) {
      var date0 = DateUtil.getDateObject(date, 'date', true);
      var date1 = DateUtil.getDateObject(
        DateUtil.getMonthTimestamp(date0.month, date0.year, 1), 'date', true);
      var date2 = DateUtil.getDateObject(
        DateUtil.getMonthTimestamp(date0.month, date0.year, 2), 'date', true);

      this.firstDate = date0;
      this.lastDate = date2;

      this.renderMonthHeaders(date0, date1, date2);

      this.renderWeeks(0, date0);
      this.renderWeeks(1, date1);
      this.renderWeeks(2, date2);
    }

    this.renderMonthHeaders = function(date0, date1, date2) {
      var headers = this.shadowRoot.querySelectorAll(".month_header td");

      headers[0].innerHTML = DateUtil.humanMonth[date0.month] + " " + date0.year;
      headers[1].innerHTML = DateUtil.humanMonth[date1.month] + " " + date1.year;
      headers[2].innerHTML = DateUtil.humanMonth[date2.month] + " " + date2.year;

    };

    this.renderWeeks = function(id, date) {
      var current_date = this.renderFirstWeek(id, date);

      for (var week = 1; week < 6; week++) {
        var tr_elem = this.shadowRoot.getElementById(id + "_week" + week);
        tr_elem.innerHTML = "";

        for (var day = 0; day < 7; day++) {
          //all days of current month are rendered
          if (current_date > date.num_days) {
            return this.renderLastWeeks(day, week, tr_elem, id, date);
          }

          tr_elem.appendChild(
            this.renderDayElem(current_date, date.month_timestamp, true));

          current_date++;
        }
      }

    }

    this.renderFirstWeek = function(id, date) {
      var preview = this.hasAttribute('data-preview');
      var prev_month =
        DateUtil.getMonthTimestamp(date.month, date.year, -1);
      var prev_dates = this.datesOfPrevMonth(prev_month, date);
      var current_date = 1;
      var tr_elem = this.shadowRoot.getElementById(id + "_week0");


      tr_elem.innerHTML = '';

      //render last days of previous month
      for (var i = 0; i < prev_dates.length; i++) {
        tr_elem.appendChild(
          this.renderDayElem(prev_dates[i], prev_month, preview));
      };

      //render first days of current month
      for (day = prev_dates.length; day < 7; day ++) {
        tr_elem.appendChild(
          this.renderDayElem(current_date, date.month_timestamp, true));
        current_date++;
      }

      return current_date;
    }

    this.renderDayElem = function(date, month_timestamp, displayed) {
      var td_elem = document.createElement("td");

      if (displayed && displayed != "false") {
        var timestamp = month_timestamp + (date - 1) * DateUtil.millisPerDay;

        td_elem.className = this.tdClassName(date, month_timestamp);

        if (this.isSelectable(date, month_timestamp)) {
          td_elem.classList.add("selectable");
          this.handleDateLinks(td_elem, date, month_timestamp);
        }

        td_elem.innerHTML = date;
      }

      return td_elem;
    };

    this.handleDateLinks = function(td_elem, date, month_timestamp) {
      var _this = this;
      var timestamp = month_timestamp + (date - 1) * DateUtil.millisPerDay;

      td_elem.onclick = function() {
        _this.fireDateSelectEvent(timestamp, this.classList.toString());
      };
    };

    this.fireDateSelectEvent = function(timestamp, classList) {
      var ev = new CustomEvent('fn-calendar-group-select', {
        'detail' : {
          'timestamp' : timestamp,
          'classList' : classList
        },
        cancelable: true,
        bubbles: true
      });

      this.dispatchEvent(ev);
    };

    this.renderLastWeeks = function(day, week, tr_elem, id, date) {
      //inidcates whether days of next months should be displayed or not
      var preview = this.hasAttribute('data-preview');

      var next_month =
        DateUtil.getMonthTimestamp(date.month, date.year, 1);
      var current_date = 1;

      //add for remaining weekdays of week days of next month
      for (; day < 7; day++) {
        tr_elem.appendChild(
          this.renderDayElem(current_date, next_month, preview));

        current_date++;
      }

      //render week with days of next month
      for (week++; week < 6; week++) {
        var tr_elem = this.shadowRoot.getElementById(id + "_week" + week);
        tr_elem.innerHTML = "";

        for (day = 0; day < 7; day++) {
          tr_elem.appendChild(
            this.renderDayElem(current_date, next_month, preview));

          current_date++;
        }
      }
    };

    this.tdClassName = function(date, month_timestamp) {
      var now = Date.now();
      var timestamp = month_timestamp + (date - 1) * DateUtil.millisPerDay;
      var name = "";

      // date isn't in current month
     /* if (month_timestamp !== this.date.month_timestamp) {
        name += " bright";
      }*/

      // date is today
      if (DateUtil.isSameDay(now, timestamp)) {
        name += " highlight_border";
      }

      if (this.hasAttribute('data-from') || this.hasAttribute('data-until')) {

        var from = this.hasAttribute('data-from') ?
          DateUtil.parseTimestamp(this.getAttribute('data-from')) : null;

        var until = this.hasAttribute('data-until') ?
          DateUtil.parseTimestamp(this.getAttribute('data-until')) : null;


        if ((from && until && timestamp >= from && timestamp <= until) ||
            (from && !until && timestamp >= from) ||
            (until && !from && timestamp <= until) ||
            DateUtil.isSameDay(from, timestamp) ||
            DateUtil.isSameDay(until, timestamp)) {
              name+= " colored";
        }

      }

      if (this.hasAttribute('data-selected')) {
        var selected_dates = [DateUtil.parseTimestamp(this.getAttribute('data-selected'))];

        for (var i = 0; i < selected_dates.length; i++) {
          // date is selected date
          if (DateUtil.isSameDay(selected_dates[i], timestamp)) {
            name += " highlight";
            break;
          }
        }
      }

      return name;
    };

    this.isSelectable = function(date, month_timestamp) {
      var now = Date.now();
      var timestamp = month_timestamp + (date - 1) * DateUtil.millisPerDay;
      var period = this.getAttribute('data-selectable');
      var select = this.getAttribute('data-select');

      if (select == 'until') {
        var from = DateUtil.parseTimestamp(this.getAttribute('data-from'));
        return timestamp >= from;
      }

      if (period == "past") {
        return (timestamp < now);
      }

      if (period == "future") {
        return (timestamp > now);
      }

      return true;
    };

    //timestamp -> beginning of last month
    this.datesOfPrevMonth = function(timestamp, date) {
      var dates = [];

      if (date.first_day == 0) {
        return dates;
      }

      var new_date = new Date(timestamp);
      var num_days = DateUtil.daysInMonth(new_date.getMonth() + 1, new_date.getYear());

      for (var i = date.first_day - 1; i >= 0; i--) {
        dates.push(num_days - i);
      }

      return dates;
    };


  }

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-calendar-group', CalendarGroup);
  }, true);
</script>
