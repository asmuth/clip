<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<template id="fn-calendar-group-base-tpl">
  <style type='text/css'>
    table {
      font-size: 1em;
      line-height: 1em;
      color: rgba(0, 0, 0, 0.8);
      border-collapse: collapse;
      border-spacing: 0;
    }

    td {
      line-height: 1.3em;
      text-align:center;
      cursor: default;
      color: inherit;
    }

    table tr {
      height: 1.98em;
    }

    table th {
      padding: 0.4em;
      line-height: 1.3em;
      text-align: center;
      font-weight: normal;
      color: inherit;
    }

    table.calendar {
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    table.calendar td {
      padding: 0.45em 0.5em;
    }

    table td.selectable:hover {
      cursor: pointer;
    }

    tr.month_header td {
      text-align: center;
      background-color: rgba(0, 0, 0, 0.1);
    }

    .fa {
      color: inherit;
      padding-left: 0.4em;
      padding-right: 0.4em;
    }

    .fa:hover {
      cursor:pointer;
    }

    .month_picker {
      vertical-align: top;
    }

    .month_picker .picker {
      padding: 3px 5px;
      background-color: #f0f0f0;
      font-size: 0.8em;
    }

    /**********************
      States
    ***********************/
    table tr.week td {
     color: rgba(0, 0, 0, 0.6); 
    }

    table tr.week td.selectable {
      color: rgba(0, 0, 0, 0.85);
    }

    table td.highlight {
      background-color: #f0f0f0;
    }

    table td.highlight_border {
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    table td.bright {
      opacity: 0.6;
    }

    table td.colored {
      background-color: #f0f0f0;
    }
  </style>

  <table id="group">
    <tr>
      <td id='prev_month_picker' class='month_picker'>
        <div class='picker'><i class='fa fa-chevron-left'></i></div>
      </td>

      <td>
        <table class='calendar' id='0'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='0_week0'></tr>
          <tr class="week" id='0_week1'></tr>
          <tr class="week" id='0_week2'></tr>
          <tr class="week" id='0_week3'></tr>
          <tr class="week" id='0_week4'></tr>
          <tr class="week" id='0_week5'></tr>
        </table>
      </td>

      <td>
        <table class='calendar' id='1'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='1_week0'></tr>
          <tr class="week" id='1_week1'></tr>
          <tr class="week" id='1_week2'></tr>
          <tr class="week" id='1_week3'></tr>
          <tr class="week" id='1_week4'></tr>
          <tr class="week" id='1_week5'></tr>
        </table>
      </td>

      <td>
        <table class='calendar' id='2'>
          <thead>
            <tr class="month_header"><td colspan='8'></td></tr>
          </thead>
          <tr>
            <th>M</th>
            <th>T</th>
            <th>W</th>
            <th>T</th>
            <th>F</th>
            <th>S</th>
            <th>S</th>
          </tr>
          <tr class="week" id='2_week0'></tr>
          <tr class="week" id='2_week1'></tr>
          <tr class="week" id='2_week2'></tr>
          <tr class="week" id='2_week3'></tr>
          <tr class="week" id='2_week4'></tr>
          <tr class="week" id='2_week5'></tr>
        </table>
      </td>

      <td id='next_month_picker' class='month_picker'>
        <div class='picker'><i class='fa fa-chevron-right'></i></div>
      </td>

    </tr>
  </table>
</template>
<script type='text/javascript'>
  var CalendarGroup = function() {
    this.createdCallback = function() {
      var shadow = this.createShadowRoot();
      var tpl = Fnord.getTemplate("fn-calendar-group", "base");
      shadow.appendChild(tpl);
      this.init();
    }

    this.init = function() {
      this.render(
        DateUtil.parseTimestamp(this.getAttribute('data-from')),
        DateUtil.parseTimestamp(this.getAttribute('data-until'))
      );
    }

    this.render = function(from, until) {
      var date0 = DateUtil.getDateObject(from, 'date', true);
      var date1 = DateUtil.getDateObject(
        DateUtil.getMonthTimestamp(date0.month, date0.year, 1), 'date', true);
      var date2 = DateUtil.getDateObject(
        DateUtil.getMonthTimestamp(date0.month, date0.year, 2), 'date', true);


      this.renderMonthHeaders(date0);

      this.renderWeeks(0, date0);
      this.renderWeeks(1, date1);
      this.renderWeeks(2, date2);
    }

    this.renderMonthHeaders = function(date) {
      var headers = this.shadowRoot.querySelectorAll(".month_header td");

      for (var i = 0; i < headers.length; i++) {
        headers[i].innerHTML = 
          DateUtil.humanMonth[(date.month + i)] + " " + date.year;
      }
    };

    this.renderWeeks = function(id, date) {
      var current_date = this.renderFirstWeek(id, date);

      for (var week = 1; week < 6; week++) {
        var tr_elem = this.shadowRoot.getElementById(id + "_week" + week);
        tr_elem.innerHTML = "";

        for (var day = 0; day < 7; day++) {
          //all days of current month are rendered
          if (current_date > date.num_days) {
            return this.renderLastWeeks(day, week, tr_elem, id, date);
          }

          tr_elem.appendChild(
            this.renderDayElem(current_date, date.month_timestamp, true));

          current_date++;
        }
      }

    }

    this.renderFirstWeek = function(id, date) {
      var preview = this.hasAttribute('data-preview');
      var prev_month =
        DateUtil.getMonthTimestamp(date.month, date.year, -1);
      var prev_dates = this.datesOfPrevMonth(prev_month, date);
      var current_date = 1;
      var tr_elem = this.shadowRoot.getElementById(id + "_week0");


      tr_elem.innerHTML = '';

      //render last days of previous month
      for (var i = 0; i < prev_dates.length; i++) {
        tr_elem.appendChild(
          this.renderDayElem(prev_dates[i], prev_month, preview));
      };

      //render first days of current month
      for (day = prev_dates.length; day < 7; day ++) {
        tr_elem.appendChild(
          this.renderDayElem(current_date, date.month_timestamp, true));
        current_date++;
      }

      return current_date;
    }

    this.renderDayElem = function(date, month_timestamp, displayed) {
      var td_elem = document.createElement("td");

      if (displayed && displayed != "false") {
        var timestamp = month_timestamp + (date - 1) * DateUtil.millisPerDay;

        //td_elem.className = this.tdClassName(date, month_timestamp);

        /*if (this.isSelectable(date, month_timestamp)) {
          td_elem.classList.add("selectable");
          this.handleDateLinks(td_elem, date, month_timestamp);
        }*/


        td_elem.innerHTML = date;
      }

      return td_elem;
    };

    this.renderLastWeeks = function(day, week, tr_elem, id, date) {
      //inidcates whether days of next months should be displayed or not
      var preview = this.hasAttribute('data-preview');

      var next_month =
        DateUtil.getMonthTimestamp(date.month, date.year, 1);
      var current_date = 1;

      //add for remaining weekdays of week days of next month
      for (; day < 7; day++) {
        tr_elem.appendChild(
          this.renderDayElem(current_date, next_month, preview));

        current_date++;
      }

      //render week with days of next month
      for (week++; week < 6; week++) {
        var tr_elem = this.shadowRoot.getElementById(id + "_week" + week);
        tr_elem.innerHTML = "";

        for (day = 0; day < 7; day++) {
          tr_elem.appendChild(
            this.renderDayElem(current_date, next_month, preview));

          current_date++;
        }
      }

    }

    //timestamp -> beginning of last month
    this.datesOfPrevMonth = function(timestamp, date) {
      var dates = [];

      if (date.first_day == 0) {
        return dates;
      }

      var new_date = new Date(timestamp);
      var num_days = DateUtil.daysInMonth(new_date.getMonth() + 1, new_date.getYear());

      for (var i = date.first_day - 1; i >= 0; i--) {
        dates.push(num_days - i);
      }

      return dates;
    };


  }

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-calendar-group', CalendarGroup);
  }, true);
</script>
