<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->

<template id="fn-metric-selector-base-tpl">
  <fn-modal-dimmer>
    <fn-modal>
      <fn-modal-close-icon></fn-modal-close-icon>
      <fn-modal-header>
        Metric Select
      </fn-modal-header>
      <fn-metrics>
      </fn-metrics>
      <fn-modal-footer>
        <fn-button data-action='add-metrics'>Add Selected</fn-button>
      </fn-modal-footer>
    </fn-modal>
  </fn-modal-dimmer>
</template>
<script type='text/javascript'>
  var MetricSelector = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-metric-selector", "base");
      this.appendChild(tpl);
      var _this = this;

      if (this.hasAttribute('data-metrics')) {
        this.renderMetrics();
      }

      this.querySelector("[data-action='add-metrics']").addEventListener(
        'click', function() {
          _this.handleSelection();
        }, false);
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-metrics') {
        this.renderMetrics();
      }
    };

    this.show = function() {
      this.clearSelection();
      this.querySelector("fn-modal").show();
    };


    this.clearSelection = function() {
      var selected = this.querySelectorAll("fn-metric[data-active]");

      for (var i = 0; i < selected.length; i++) {
        selected[i].removeAttribute('data-active');
        selected[i].querySelector("fn-checkbox").removeAttribute('data-active');
      }
    }

    this.handleSelection = function() {
      var selected = this.querySelectorAll("fn-metric[data-active]");
      var selection  = [];

      for (var i = 0; i < selected.length; i++) {
        selection.push({
          group: selected[i].getAttribute('data-group'),
          key: selected[i].getAttribute('data-key')
        });
      }

      this.fireSelectionEvent(selection);
    };


    this.renderTitleElem = function(node, hierarchy) {
      var elem = document.createElement("fn-metrics-title");
      elem.innerHTML = node.name;
      elem.style.paddingLeft = hierarchy * 15 + 28 + "px";

      return elem;
    };

    this.renderMetricElem = function(leaf, hierarchy) {
      var elem = document.createElement("fn-metric");
      var checkbox = document.createElement("fn-checkbox");
      var title = document.createElement("fn-metric-title");
      var description = document.createElement("fn-metric-description");
      title.innerHTML = leaf.name;
      description.innerHTML = (leaf.description.length > 0) ?
        "<span>&#45;</span>" + leaf.description : "";
      elem.appendChild(checkbox);
      elem.appendChild(title);
      elem.appendChild(description);
      elem.setAttribute('data-key', leaf.key);
      elem.style.paddingLeft = hierarchy * 15 + 28 + "px";

      checkbox.addEventListener('click', function() {
        if (elem.hasAttribute('data-active')) {
          elem.removeAttribute('data-active');
        } else {
          elem.setAttribute('data-active', 'active');
        }
      }, false);

      return elem;
    };

    this.renderMetricsTree = function() {
      var _this = this;
      var container = this.querySelector("fn-metrics");
      var metrics = JSON.parse(this.getAttribute('data-metrics'));

      container.innerHTML = "";
      var hierarchy = 0;

      function traverse(node, func) {
        func(node);

        for (var i = 0; i < node.children.length; i++) {
          traverse(node.children[i], func);
        }
      }

      metrics.forEach(function(metric) {
        hierarchy = 0;
        traverse(metric, function(node) {
          if (node.children.length > 0) {
            container.appendChild(_this.renderTitleElem(node, hierarchy));
            hierarchy++;
          } else {
            container.appendChild(_this.renderMetricElem(node, hierarchy));
          }
        });
      });
    };


    this.renderMetricsGroup = function() {
      var _this = this;
      var container = this.querySelector("fn-metrics");
      var metrics = JSON.parse(this.getAttribute('data-metrics'));

      container.innerHTML = "";
      for (var group in metrics) {
        container.appendChild(_this.renderTitleElem({name: group}, 0));

        metrics[group].forEach(function(metric) {
          var elem = _this.renderMetricElem(metric, 1);
          elem.setAttribute('data-group', group);
          container.appendChild(elem);
        });
      }
    };



    this.renderMetrics = function() {
      var format = this.getAttribute('data-format');

      switch (format) {
        case 'tree':
          this.renderMetricsTree();
          return;

        case 'group':
          this.renderMetricsGroup();
          return;

        default:
          return;
      }
    };

    this.fireSelectionEvent = function(selection) {
      var ev = new CustomEvent('fn-metric-selector-add', {
        detail: {metrics: selection},
        cancelable: true,
        bubbles: true
      });

      this.dispatchEvent(ev);
    }
  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-metric-selector', MetricSelector);
  });
</script>
