<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2015 Laura Schlimmer
    Copyright (c) 2015 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->

<template id="fn-segment-editor-base-tpl">
  <fn-input class='icon'>
    <input class='segment-clickable' data-action='open-segment-editor' readonly type='text' />
    <fn-input-icon class='segment-clickable' data-action='open-segment-editor'><i class='fa fa-plus'></i></fn-input-icon>
  </fn-input>

  <fn-modal-dimmer data-active>
    <fn-modal>
      <fn-modal-close-icon></fn-modal-close-icon>

      <fn-segment-overview class='segment-active'>
        <fn-segment-header>
          <fn-segment-header-title>Segments</fn-segment-header-title>
        </fn-segment-header>

        <fn-segments></fn-segments>

        <fn-segment-footer>
          <fn-button>Add Segment</fn-button>
        </fn-segment-footer>
      </fn-segment-overview>

      <fn-segment-select>
        <fn-segment-header>
          <fn-segment-header-title>Name</fn-segment-header-title>
          <input class='fn-input' />
        </fn-segment-header>

        <fn-segment-options></fn-segment-options>

        <fn-segment-footer>
          <fn-button>Save</fn-button>
        </fn-segment-footer>
      </fn-segment-select>

    </fn-modal>
  </fn-modal-dimmer>
</template>

<script type='text/javascript'>
  var SegmentEditor = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-segment-editor", "base");
      this.appendChild(tpl);

      this.init();
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == 'data-resolved' && new_val == 'resolved') {
        this.init();
      }
    }

    this.init = function() {
      var _this = this;
      var elems = this.querySelectorAll("[data-action='open-segment-editor']");

      for (var i = 0; i < elems.length; i++) {
        elems[i].onclick = function() {
          _this.toggleVisibility();
        }
      }

      this.handleViewVisibilty();
    };

    this.toggleVisibility = function() {
      var dimmer = this.querySelector("fn-modal-dimmer");
      var modal = this.querySelector("fn-modal");

      if (dimmer.hasAttribute('data-active')) {
        modal.close();
      } else {
        modal.show();
      }
    };

    this.handleViewVisibility = function() {

    }

    this.addSegments = function(json) {
      var segments = JSON.parse(json);
      var _this = this;

      segments.forEach(function(segment) {
        _this.addSegment(segment);
      }, false);
    }

    this.addSegment = function(segment) {
      var fn_segments = this.querySelector("fn-segments");
      var fn_segment = document.createElement("fn-segment");

      var html = ["<fn-segment-title>", segment.name, "</fn-segment-title>"];

      segment.selection.forEach(function(s) {
        html.push(
          "<fn-segment-text-title>", s.key, ":",
          "</fn-segment-text-title>", "<fn-segment-text-value>", s.value.join(", "),
          "</fn-segment-text-value>"
        );
      });

      if (segment.removable) {
        html.push("<fn-segment-remove-icon></fn-segment-remove-icon>");
      }

      if (segment.editable) {
        html.push("<fn-segment-edit-icon></fn-segment-edit-icon>");
      }

      console.log(html.join(""));
      fn_segment.innerHTML = html.join("");
      fn_segments.appendChild(fn_segment);
    }
  }
  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-segment-editor', SegmentEditor);
    //Fnord.registerComponent('fn-segment-editor-element'
  }, false);
</script>
