<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<script type='text/javascript'>
  var DateTimeSelector = function() {
    this.createdCallback = function() {

      if (this.hasAttribute('data-resolved')) {
        this.init();
      }

    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if ((attr != 'data-resolved') && !this.hasAttribute('data-resolved')) {
        return;
      }

      switch (attr) {
          case 'data-resolved':
          this.init();
          break;
        case 'data-until':
          this.checkUntilAttr(false);
          this.updateUntil();
          break;
        case 'data-precision':
          this.checkPrecisionAttr();
          break;
        case 'data-range':
          this.checkRangeAttr();
          this.updateRange();
          break;
        default:
          break;
      }
    };

    this.checkUntilAttr = function() {
      var until = DateUtil.parseTimestamp(this.getAttribute('data-until'));
      this.setAttribute('data-until', until);

      this.timestamp = DateUtil.getTimestampObj(
        until, this.getAttribute('data-utc-offset')
      );
    };

    this.checkRangeAttr = function() {
      var range = parseInt(this.getAttribute('data-range'), 10);
      if (isNaN(range)) {
        this.setAttribute('data-range', 900000);
      }
    };

    this.checkPrecisionAttr = function() {
      var precision = this.getAttribute('data-precision');
      var allowed_precisions = ["hour", "minute", "second"];

      if (allowed_precisions.indexOf(precision) == -1) {
        this.setAttribute('data-precision', 'minute');
      }
    };

    this.init = function() {
      this.renderWidget();
      this.checkRangeAttr();
      this.checkUntilAttr();
      this.checkPrecisionAttr();
      this.updateRange();
      this.updateUntil();
      this.observeActions();
    };

    this.updateRange = function() {
      var dropdown = this.querySelector("fn-dropdown");

      dropdown.setAttribute('data-preselected', this.getAttribute('data-range'));
      dropdown.setAttribute('data-resolved', 'resolved');
    };

    this.renderWidget = function() {
      var header = this.querySelector("fn-date-time-selector-header");
      var widget = this.querySelector("fn-date-time-selector-widget");
      var calendar;
      var select_restriction = this.getAttribute('data-selectable');

      if (!header) {
        header = document.createElement("fn-date-time-selector-header");
        this.insertBefore(header, this.querySelector("fn-dropdown").nextElementSibling);
      }

      if (!widget) {
        widget = document.createElement("fn-date-time-selector-widget");
        calendar = document.createElement("fn-calendar");

        this.insertBefore(widget, header.nextElementSibling);

        widget.appendChild(document.createElement("fn-timeinput"));
        widget.appendChild(calendar);
      } else {
        calendar = widget.querySelector("fn-calendar");
      }

      if (select_restriction) {
        calendar.setAttribute('data-selectable', select_restriction);
      }

      widget.onDocumentClick = function() {
        this.removeAttribute('data-active');
      }
    }

    this.updateUntil = function() {
      var header = this.querySelector("fn-date-time-selector-header");
      var calendar = this.querySelector("fn-calendar");
      var timeinput = this.querySelector("fn-timeinput");


      var date = DateUtil.getDateObject(
        this.timestamp.date + this.timestamp.time,
        this.getAttribute('data-precision'),
        false
      );

      //TODO timedescr from timestamp
      header.innerHTML = DateUtil.getDateTimeDescr(date);

      calendar.setAttribute('data-selected', this.timestamp.date);
      calendar.setAttribute('data-timestamp', this.timestamp.date);
      timeinput.setAttribute(
        'data-timestamp', this.timestamp.time);
    };


    this.openWidget = function() {
      var widget = this.querySelector("fn-date-time-selector-widget");
      var pos = this.getBoundingClientRect();

      widget.setAttribute('data-selected', this.getAttribute('data-until'));
      widget.setAttribute('data-active', 'active');

      //center widget relative to wrapper_elem
      widget.style.marginLeft = ((pos.width - widget.offsetWidth) / 2) + "px";
    }

    this.closeWidget = function(until) {
      var range = this.getAttribute('data-range');
      this.querySelector("fn-date-time-selector-widget").removeAttribute("data-active");

      if (until && this.isSelectable(range, until)) {
        this.setAttribute('data-until', until);
        this.fireEvent(
            'fn-date-time-selector-until', {"until" : until})
      }
    };

    //checks if until and from matches the data-selectable condition
    this.isSelectable = function(range, until) {
      var condition = this.getAttribute('data-selectable');

      if (!condition) {
        return true;
      }

      if (condition == 'future') {
        return (until - range > Date.now());
      }

      if (condition == 'past') {
        return (until <= Date.now());
      }

      //not supported data-selectable attribute
      return true;
    }

    this.onIconClick = function(direction) {
      var range = parseInt(this.getAttribute('data-range'), 10);
      var until = parseInt(this.getAttribute('data-until'), 10);

      if (direction == 'left') {
        until = until - range;
      } else if (direction == 'right') {
        until = until + range;
      }

      if (this.isSelectable(range, until)) {
        this.setAttribute('data-until', until);
        this.fireEvent('fn-date-time-selector-until', {"until" :until});
      }
    }

    this.observeActions = function() {
      var base = this;
      var widget = this.querySelector("fn-date-time-selector-widget");
      var timeinput = widget.querySelector("fn-timeinput");
      var calendar = widget.querySelector("fn-calendar");
      var icon_left = this.querySelector("fn-date-time-selector-icon.left");
      var icon_right = this.querySelector("fn-date-time-selector-icon.right");

      if (icon_left) {
        icon_left.onclick = function() {
          base.onIconClick('left');
        };
      }

      if (icon_right) {
        icon_right.onclick = function() {
          base.onIconClick('right');
        }
      }

      this.querySelector("fn-dropdown").addEventListener(
        'fn-dropdown-item-click', function(e) {
          var range = e.srcElement.getAttribute('data-value');
          base.setAttribute(
            'data-range', range);
          base.fireEvent('fn-date-time-selector-range', {"range": range});
        },
      false);

      this.querySelector("fn-date-time-selector-header").onclick = function(e) {
        e.stopPropagation();
        if (widget.classList.contains("active")) {
          base.closeWidget();
        } else {
          base.openWidget();
        }
      };

      widget.onclick = function(e) {
        e.stopPropagation();
      };

      calendar.addEventListener('fn-calendar-select',
        function(e) {
          base.closeWidget(e.detail.timestamp + timeinput.getValues().timestamp);
        },
      false);

      timeinput.addEventListener('fn-timeinput-submit',
        function(e) {
          base.closeWidget(
            e.detail.timestamp +
            parseInt(calendar.getAttribute('data-selected'), 10));
        },
      false);
    };

    this.fireEvent = function(name, detail) {
      var timeEvent = new CustomEvent(
        name, {
          'detail': detail,
          bubbles: true,
          cancealable: true
      });

      this.dispatchEvent(timeEvent);
    }

  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-date-time-selector', DateTimeSelector);
  }, false);
</script>
