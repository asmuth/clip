<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.

  todo: add seconds-selectable and render third input if attr is set
-->
<style type='text/css'>
  fn-timeinput {
    display:block;
  }
</style>
<template id="fn-timeinput-base-tpl">
  <style>
    #timeinput_container {
      margin:auto;
      height: 35px;
      width: 114px;
    }

    input {
      float: left;
      outline: none;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
      text-align: left;
      line-height: 1.2142em;
      font-family: "Helvetica Neue", "Helvetica", Arial;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.15);
      color: rgba(0, 0, 0, 0.8);
      border-radius: 0.2857rem;
      -webkit-transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
              transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      box-shadow: none;
    }

    input::-webkit-input-placeholder {
      color: rgba(0, 0, 0, 0.4);
    }
    input::-moz-placeholder {
      color: rgba(0, 0, 0, 0.4);
    }
    input:focus {
      border-color: rgba(39, 41, 43, 0.3);
      background: '';
      color: rgba(0, 0, 0, 0.8);
      box-shadow: none;
    }
    input:focus input::-webkit-input-placeholder {
      color: rgba(0, 0, 0, 0.8);
    }
    input:focus input::-moz-placeholder {
      color: rgba(0, 0, 0, 0.8);
    }

    input:active {
      border-color: rgba(0, 0, 0, 0.3);
      background: #fafafa;
      color: rgba(0, 0, 0, 0.8);
      box-shadow: none;
    }

    input.error {
      background-color: #fff0f0;
      border-color: #dbb1b1;
      color: #d95c5c;
      box-shadow: none;
    }

    b {
      line-height: 1.2142em;
      padding-top: 0.60861em;
      float:left;
      margin: 0 5px;
    }

    /*********************
        Sizes
    *********************/
    #timeinput_container input {
      width: 50px;
      font-size: 1rem;
      padding: 0.60861em 1em;
    }

    #timeinput_container.small {
      height: 30px;
      width: 98px;
    }

    #timeinput_container.small input{
      font-size: 0.875rem;
      width: 20px;
      padding: 0.5em 0.8em;
    }


  </style>

  <div id="timeinput_container">
    <input id="hours"/>
    <b>:</b>
    <input id="minutes" />
  </div>
</template>
<script type="text/javascript">
  var TimeInputComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-timeinput", "base");
      var shadow = this.createShadowRoot();
      var base = this;
      shadow.appendChild(tpl);

      var hours_input = this.shadowRoot.querySelector("#hours");
      var minutes_input = this.shadowRoot.querySelector("#minutes");

      if (this.hasAttribute('data-hours-value')) {
        this.setHoursValue(this.getAttribute('data-hours-value'));
      }
      if (this.hasAttribute('data-minutes-value')) {
        this.setMinutesValue(this.getAttribute('data-minutes-value'));
      }
      if (this.hasAttribute('data-state')) {
        this.setState();
      }

      hours_input.addEventListener('focus', function() {
        base.validateHoursInput();
      }, false);
      minutes_input.addEventListener('focus', function() {
        base.validateMinutesInput();
      }, false);
    };

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      switch (attr) {
        case "data-minutes-value":
        this.setMinutesValue(new_val);
        break;

        case "data-hours-value":
        this.setHoursValue(new_val);
        break;

        case 'data-size':
        this.setSize(new_val);
        break;

        default:
        break;
      }
    }

    this.setSize = function(size) {
      this.shadowRoot.querySelector("#timeinput_container").classList.add(size);
    }

    this.validateHoursInput = function() {
      var base = this;
      var input = this.shadowRoot.querySelector("#hours");
      input.maxLength = "2";

      input.addEventListener('keypress', function(e) {
        if (e.keyCode == 13 ) {
          var value = parseInt(this.value);
          if (value > 23) {
            this.className = "error";
            return;
          }
          this.className = "";
          base.setAttribute('data-hours-value', value);
          base.fireTimeInputSubmitEvent();
          return;
        }
        if (!base.isNavKey(e.keyCode) &&
          !base.isNumKey(e.keyCode)) {
            e.preventDefault();
        }
      }, false);
    };

    this.validateMinutesInput = function() {
      var base = this;
      var input = this.shadowRoot.querySelector("#minutes");
      input.maxLength = "2";

      input.addEventListener('keypress', function(e) {
        if (e.keyCode == 13 ) {
          var value = parseInt(this.value);
          if (value > 59) {
            this.className = "error";
            return;
          }
          this.className = "";
          base.setAttribute('data-minutes-value', value);
          base.fireTimeInputSubmitEvent();
          return;
        }
        if (!base.isNavKey(e.keyCode) &&
          !base.isNumKey(e.keyCode)) {
            e.preventDefault();
        }
      }, false);
    };

    this.appendLeadingZero = function (num) {
      var num = num;
      if (typeof num == 'string') {
        return (num.length > 1)? num : "0" + num;
      }
      return (num > 9)? num : "0" + num;
    };

    this.isNavKey = function(keycode) {
      return (
          keycode == 8 ||
          keycode == 9 ||
          keycode == 37 ||
          keycode == 39 ||
          keycode == 46);
    };

    this.isNumKey = function(keycode) {
      return (
        (keycode >= 48 && keycode <= 57));
    };


    this.setHoursValue = function(value) {
      var input = this.shadowRoot.querySelector("#hours");

      if (parseInt(value, 10) > 23) {
        input.className = "error";
      }

      input.value = this.appendLeadingZero(value);

    };

    this.setMinutesValue = function(value) {
      var input = this.shadowRoot.querySelector("#minutes");

      if (parseInt(value, 10) > 59) {
        input.className = "error";
      }

      input.value = this.appendLeadingZero(value);
    };

    this.validateHoursInput = function() {
      var base = this;
      var input = this.shadowRoot.querySelector("#hours");
      input.maxLength = "2";

      input.addEventListener('keypress', function(e) {
        if (e.keyCode == 13 ) {
          var value = parseInt(this.value);
          if (value > 23) {
            this.className = "highlighted";
            return;
          }
          this.className = "";
          base.fireTimeInputSubmitEvent();
          return;
        }
        if (!base.isNavKey(e.keyCode) &&
          !base.isNumKey(e.keyCode)) {
            e.preventDefault();
        }
      }, false);
    };

    this.validateMinutesInput = function() {
      var base = this;
      var input = this.shadowRoot.querySelector("#minutes");
      input.maxLength = "2";

      input.addEventListener('keypress', function(e) {
        if (e.keyCode == 13 ) {
          var value = parseInt(this.value);
          if (value > 59) {
            this.className = "highlighted";
            return;
          }
          this.className = "";
          base.fireTimeInputSubmitEvent();
          return;
        }
        if (!base.isNavKey(e.keyCode) &&
          !base.isNumKey(e.keyCode)) {
            e.preventDefault();
        }
      }, false);
    };

    this.setHoursValue = function(value) {
      this.shadowRoot.querySelector(
        "#hours").value = this.appendLeadingZero(value);
    };

    this.setMinutesValue = function(value) {
      this.shadowRoot.querySelector(
        "#minutes").value = this.appendLeadingZero(value);
    };

    this.getValues = function() {
      return {
        'hours' : this.shadowRoot.querySelector("#hours").value,
        'minutes' : this.shadowRoot.querySelector("#minutes").value};
    };

    this.fireTimeInputSubmitEvent = function() {
      var submitEvent = new CustomEvent('fn-timeinput-submit', {
        'detail' : this.getValues(),
        bubbles: true,
        cancealable : true
      })

      this.dispatchEvent(submitEvent);
    };
  }

  window.addEventListener('fn-ready', function() {
    var timeinput = Fnord.registerComponent('fn-timeinput', TimeInputComponent);
  }, false);
</script>

