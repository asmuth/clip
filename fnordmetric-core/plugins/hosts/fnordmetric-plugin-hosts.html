<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
-->
<style type="text/css">
</style>

<template id="fnordmetric-plugin-hosts-overview-tpl">
  <h1 class="page_header"><i>Hosts</i> &rsaquo; All Hosts</h1>

  <fn-loader data-loader-type="loader3" data-transparent>
    <fn-table data-per-page="25" data-clickable id="host-list" style="width:100%;">
      <fn-table-column>Hostname</fn-table-column>
      <fn-table-column>Load Avg</fn-table-column>
      <fn-table-column>CPU Util</fn-table-column>
      <fn-table-column>Mem. Total (MB)</fn-table-column>
      <fn-table-column>Mem. Util</fn-table-column>
      <fn-table-column>Disk Total (GB)</fn-table-column>
      <fn-table-column>Disk Util</fn-table-column>
    </fn-table>
  </fn-loader>
</template>

<template id="fnordmetric-plugin-hosts-detail-tpl">
  <h1 class="page_header"></h1>

  <fnordmetric-time-controls>
  </fnordmetric-time-controls>
</template>

<script type="text/javascript">
  var FnordMetricHostsPluginComponent = function() {
    this.openUrl = function(url) {
      this.innerHTML = "";
      var qry = Fnord.parseQueryString(url);

      if (qry.params.view == "detail") {
        this.renderDetailView(qry.params.hostname);
      } else {
        this.renderOverview();
      }
    };

    this.renderOverview = function() {
      var tpl = Fnord.getTemplate("fnordmetric-plugin-hosts", "overview");
      this.innerHTML = "";
      this.appendChild(tpl);

      var table = this.querySelector("#host-list");
      table.addEventListener("fn-table-row-click", function(e) {
        var hostname = e.srcElement.getAttribute("data-hostname");
        var url = "console?plugin=hosts&view=detail&hostname=" + encodeURIComponent(hostname);
        document.querySelector("fnordmetric-app").openUrl(url);
      }, false);

      Fnord.jsonRPC("/rpc", "GroupsService.getMembers", { 
        group: "fnordmetric-hosts-plugin-hostnames"
      }, function(hosts) {
        var kv_keys = [];
        for (var i = 0; i < hosts.length; ++i) {
          kv_keys.push("fnordmetric-hosts-plugin-hostdata~" + hosts[i]);
        }

        Fnord.jsonRPC("/rpc", "KeyValueService.mget", { keys: kv_keys },
            function(host_data) {
          for (var i = 0; i < hosts.length; ++i) {
            var hname = hosts[i];
            var hdata = host_data[i];

            if (hdata.length == 0) {
              console.log("missing data for host", hname);
              continue;
            } else {
              hdata = JSON.parse(hdata);
            }

            var row = table.appendRowFromArray([
                hname,
                hdata.load_avg,
                "Loading...",
                "Loading...",
                "Loading...",
                "Loading...",
                "Loading..." 
            ]);
            row.setAttribute("data-hostname", hname);
          }
        });
      });
    }

    this.renderDetailView = function(hostname) {
      var tpl = Fnord.getTemplate("fnordmetric-plugin-hosts", "detail");
      this.appendChild(tpl);

      this.querySelector("h1").innerHTML = "<i>Hosts</i> &rsaquo; " + hostname;
    }

    this.createdCallback = function() {
      if (this.getAttribute("data-url")) {
        this.openUrl(this.getAttribute("data-url"));
      }
    }

    this.attributeChangedCallback = function(attr, old_val, new_val) {
      if (attr == "data-url") {
        this.openUrl(new_val);
      }
    }
  };

  window.addEventListener("fn-ready", function() {
    Fnord.registerComponent(
        "fnordmetric-plugin-hosts",
        FnordMetricHostsPluginComponent);
  }, false);
</script>
